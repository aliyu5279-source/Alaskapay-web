name: Deployment Status Notifications

on:
  deployment_status:

jobs:
  notify-deployment:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    if: github.event.deployment_status.state != 'pending'
    
    steps:
      - name: ğŸ“§ Discord Notification - Success
        if: github.event.deployment_status.state == 'success'
        uses: sarisia/actions-status-discord@v1
        continue-on-error: true
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: 'success'
          title: 'âœ… Deployment Successful'
          description: |
            **Environment:** ${{ github.event.deployment.environment }}
            **URL:** ${{ github.event.deployment_status.target_url }}
            **Commit:** ${{ github.sha }}
          color: 0x00ff00
          url: ${{ github.event.deployment_status.target_url }}

      - name: ğŸ“§ Discord Notification - Failure
        if: github.event.deployment_status.state == 'failure'
        uses: sarisia/actions-status-discord@v1
        continue-on-error: true
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: 'failure'
          title: 'âŒ Deployment Failed'
          description: |
            **Environment:** ${{ github.event.deployment.environment }}
            **Commit:** ${{ github.sha }}
            **Check logs for details**
          color: 0xff0000
          url: ${{ github.server_url }}/${{ github.repository }}/actions

      - name: ğŸ“§ Email Notification
        if: github.event.deployment_status.state == 'success' || github.event.deployment_status.state == 'failure'
        uses: dawidd6/action-send-mail@v3
        continue-on-error: true
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: |
            ${{ github.event.deployment_status.state == 'success' && 'âœ…' || 'âŒ' }} 
            Deployment ${{ github.event.deployment_status.state }} - ${{ github.repository }}
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: GitHub Actions <${{ secrets.SMTP_USERNAME }}>
          body: |
            Deployment Status: ${{ github.event.deployment_status.state }}
            
            Repository: ${{ github.repository }}
            Environment: ${{ github.event.deployment.environment }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
            
            ${{ github.event.deployment_status.state == 'success' && format('Deployment URL: {0}', github.event.deployment_status.target_url) || 'Check logs for error details' }}
            
            View Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: ğŸ“ Create GitHub Comment
        if: github.event.deployment_status.state == 'success'
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const commits = await github.rest.repos.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              per_page: 1
            });
            
            if (commits.data.length > 0) {
              await github.rest.repos.createCommitComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: context.sha,
                body: `ğŸš€ **Deployed Successfully**\n\n**Environment:** ${{ github.event.deployment.environment }}\n**URL:** ${{ github.event.deployment_status.target_url }}\n**Status:** ${{ github.event.deployment_status.state }}`
              });
            }
