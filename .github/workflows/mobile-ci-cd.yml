name: Mobile CI/CD - Auto Deploy

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'android/**'
      - 'ios/**'
      - 'package.json'
      - 'capacitor.config.ts'
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  version-bump:
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.bump.outputs.new_version }}
      build_number: ${{ steps.bump.outputs.build_number }}
    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Bump version
        id: bump
        run: |
          BUMP_TYPE="${{ github.event.inputs.version_bump || 'patch' }}"
          npm version $BUMP_TYPE --no-git-tag-version
          NEW_VERSION=$(node -p "require('./package.json').version")
          BUILD_NUMBER=${{ github.run_number }}
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          
      - name: Update iOS version
        run: |
          cd ios/App
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString ${{ steps.bump.outputs.new_version }}" App/Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion ${{ steps.bump.outputs.build_number }}" App/Info.plist
          
      - name: Update Android version
        run: |
          cd android/app
          sed -i "s/versionName \".*\"/versionName \"${{ steps.bump.outputs.new_version }}\"/" build.gradle
          sed -i "s/versionCode .*/versionCode ${{ steps.bump.outputs.build_number }}/" build.gradle
          
      - name: Commit version bump
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add package.json package-lock.json ios/App/App/Info.plist android/app/build.gradle
          git commit -m "chore: bump version to ${{ steps.bump.outputs.new_version }} (build ${{ steps.bump.outputs.build_number }})"
          git push

  deploy-ios:
    needs: version-bump
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3
        with:
          ref: main
          
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build web app
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          
      - name: Sync Capacitor
        run: npx cap sync ios
        
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.0'
          bundler-cache: true
          working-directory: ios/App
          
      - name: Install Fastlane
        run: cd ios/App && bundle install
        
      - name: Setup certificates
        run: |
          mkdir -p ~/.appstoreconnect/private_keys
          echo "${{ secrets.APP_STORE_CONNECT_API_KEY }}" | base64 -d > ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_KEY_ID }}.p8
          
      - name: Deploy to TestFlight
        run: cd ios/App && bundle exec fastlane beta
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.FASTLANE_PASSWORD }}
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_ISSUER_ID }}
          
      - name: Upload IPA
        uses: actions/upload-artifact@v3
        with:
          name: ios-app-${{ needs.version-bump.outputs.new_version }}
          path: ios/App/*.ipa

  deploy-android:
    needs: version-bump
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          ref: main
          
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build web app
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          
      - name: Sync Capacitor
        run: npx cap sync android
        
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.0'
          bundler-cache: true
          working-directory: android
          
      - name: Install Fastlane
        run: cd android && bundle install
        
      - name: Decode keystore
        run: echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/app/release.keystore
        
      - name: Deploy to Internal Testing
        run: cd android && bundle exec fastlane internal
        env:
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          SUPPLY_JSON_KEY_DATA: ${{ secrets.PLAY_STORE_JSON_KEY }}
          
      - name: Upload AAB
        uses: actions/upload-artifact@v3
        with:
          name: android-app-${{ needs.version-bump.outputs.new_version }}
          path: android/app/build/outputs/bundle/release/*.aab

  notify:
    needs: [version-bump, deploy-ios, deploy-android]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Notify team
        run: |
          curl -X POST "${{ secrets.VITE_SUPABASE_URL }}/functions/v1/notify-beta-testers" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "platform": "both",
              "version": "${{ needs.version-bump.outputs.new_version }}",
              "build": "${{ needs.version-bump.outputs.build_number }}",
              "ios_status": "${{ needs.deploy-ios.result }}",
              "android_status": "${{ needs.deploy-android.result }}"
            }'
